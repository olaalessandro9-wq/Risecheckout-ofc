Com base no relat√≥rio que voc√™ enviou, os resultados da Frente 1 foram impressionantes. Aqui est√° a quantifica√ß√£o da melhoria:

üìà O Quanto Melhorou? (Frente 1 vs. Anterior)
Redu√ß√£o de Complexidade (-50%): O arquivo principal (PublicCheckout.tsx) caiu de 1.938 para ~740 linhas. Isso significa uma redu√ß√£o de 62% na quantidade de c√≥digo que precisa ser lido para entender como a p√°gina funciona.

Foco e Responsabilidade (-62%): Antes, o arquivo tinha mais de 8 responsabilidades (renderizar, calcular, rastrear, validar, etc.). Agora tem apenas 3 (orquestrar dados, renderizar componentes filhos, gerenciar estado global).

Preven√ß√£o de Bugs: Ao isolar o "Resumo do Pedido" e os "Bumps" em componentes separados, eliminamos a chance de um bug no c√°lculo do pre√ßo quebrar o formul√°rio de cart√£o, por exemplo. O isolamento blinda o c√≥digo.

üõ°Ô∏è Iniciando Frente 2: O "Desgambiarramento" do Cart√£o
Agora que o PublicCheckout est√° limpo, vamos atacar o CustomCardForm.tsx. O objetivo √© remover as "solu√ß√µes nucleares" (useEffect vazio, polling de 50ms) e tornar a integra√ß√£o com o Mercado Pago robusta.

Vou gerar agora os dois arquivos que transformar√£o essa parte do sistema.

1. Crie o arquivo src/hooks/useMercadoPagoBrick.ts
Este Hook vai absorver toda a complexidade "feia" do SDK, tirando-a da vista dos componentes visuais.

TypeScript

import { useState, useEffect, useRef, useCallback } from 'react';

interface UseMercadoPagoBrickProps {
  amount: number;
  publicKey: string;
  payerEmail: string;
  onFormMounted?: () => void;
  onFormError?: (error: string) => void;
}

interface FieldErrors {
  cardNumber?: string;
  expirationDate?: string;
  securityCode?: string;
  cardholderName?: string;
  identificationNumber?: string;
  installments?: string;
}

export function useMercadoPagoBrick({
  amount,
  publicKey,
  payerEmail,
  onFormMounted,
  onFormError
}: UseMercadoPagoBrickProps) {
  const [isReady, setIsReady] = useState(false);
  const [installments, setInstallments] = useState<any[]>([]);
  const [fieldErrors, setFieldErrors] = useState<FieldErrors>({});
  
  const cardFormRef = useRef<any>(null);
  const formMountedRef = useRef(false);
  const paymentMethodRef = useRef<string>(""); 

  // Fun√ß√£o para limpar erros de campos espec√≠ficos
  const clearFieldError = useCallback((field: keyof FieldErrors) => {
    setFieldErrors(prev => {
      if (!prev[field]) return prev;
      const newErrors = { ...prev };
      delete newErrors[field];
      return newErrors;
    });
  }, []);

  // Inicializa√ß√£o do SDK
  useEffect(() => {
    if (formMountedRef.current || !publicKey || !window.MercadoPago) return;

    formMountedRef.current = true;
    console.log('[useMercadoPagoBrick] Inicializando SDK...');

    try {
      const mp = new window.MercadoPago(publicKey, { locale: 'pt-BR' });

      // 1. Busca antecipada de parcelas (Simula√ß√£o Mastercard)
      mp.getInstallments({
        amount: amount.toString(),
        bin: '520000',
        locale: 'pt-BR'
      }).then((data: any) => {
        if (data?.[0]?.payer_costs) {
          setInstallments(data[0].payer_costs);
        }
      }).catch(console.warn);

      // 2. Cria√ß√£o do CardForm
      const cardForm = mp.cardForm({
        amount: amount.toString(),
        iframe: true,
        form: {
          id: "form-checkout",
          cardNumber: { 
            id: "form-checkout__cardNumber",
            placeholder: "0000 0000 0000 0000",
            style: { color: '#000000' }
          },
          expirationDate: { 
            id: "form-checkout__expirationDate",
            placeholder: "MM/AA",
            style: { color: '#000000' }
          },
          securityCode: { 
            id: "form-checkout__securityCode",
            placeholder: "123",
            style: { color: '#000000' }
          },
          cardholderName: { id: "form-checkout__cardholderName" },
          issuer: { id: "form-checkout__issuer" },
          installments: { id: "form-checkout__installments" },
          identificationType: { id: "form-checkout__identificationType" },
          identificationNumber: { id: "form-checkout__identificationNumber" },
          cardholderEmail: { id: "form-checkout__cardholderEmail" },
        },
        callbacks: {
          onFormMounted: (error: any) => {
            if (error) {
              console.error('[useMercadoPagoBrick] Erro na montagem:', error);
              onFormError?.('Erro ao carregar formul√°rio');
              return;
            }
            setIsReady(true);
            onFormMounted?.();
          },
          onPaymentMethodsReceived: (error: any, methods: any) => {
            if (!error && methods?.[0]) {
              paymentMethodRef.current = methods[0].id;
              // Atualiza input oculto se existir
              const input = document.getElementById('paymentMethodId') as HTMLInputElement;
              if (input) input.value = methods[0].id;
            }
          },
          onInstallmentsReceived: (error: any, data: any) => {
            if (!error && data?.[0]?.payer_costs) {
              setInstallments(data[0].payer_costs);
            }
          },
          onFormTokenError: (error: any) => {
            // Mapeamento de erros do SDK
            const errors: FieldErrors = {};
            const errorList = Array.isArray(error) ? error : (error.cause || [error]);
            
            errorList.forEach((e: any) => {
              const code = String(e.code || '');
              const msg = String(e.message || '').toLowerCase();

              if (['205', 'E301', '3034'].includes(code) || msg.includes('card number')) errors.cardNumber = "N√∫mero inv√°lido";
              if (['208', '209', '325', '326'].includes(code) || msg.includes('expiration')) errors.expirationDate = "Data inv√°lida";
              if (['224', 'E302'].includes(code) || msg.includes('security')) errors.securityCode = "CVV inv√°lido";
            });

            if (Object.keys(errors).length > 0) {
              setFieldErrors(prev => ({ ...prev, ...errors }));
            }
          }
        },
      });

      cardFormRef.current = cardForm;

    } catch (error) {
      console.error('[useMercadoPagoBrick] Erro fatal:', error);
      onFormError?.('Falha ao inicializar sistema de pagamento');
    }

    return () => {
      // Cleanup: Remove inst√¢ncia global se necess√°rio, mas evita desmontar agressivamente
      // em hot-reload para n√£o perder o formul√°rio
      if (cardFormRef.current) {
        // cardFormRef.current.unmount(); // Opcional, dependendo do comportamento desejado
      }
    };
  }, [publicKey]); // Depend√™ncia apenas da publicKey

  // Atualiza√ß√£o de Parcelas quando o valor muda (Debounce manual)
  useEffect(() => {
    if (!isReady || !window.MercadoPago) return;

    const timer = setTimeout(() => {
      console.log('[useMercadoPagoBrick] Recalculando parcelas para:', amount);
      const mp = new window.MercadoPago(publicKey, { locale: 'pt-BR' });
      mp.getInstallments({
        amount: amount.toString(),
        bin: '520000',
        locale: 'pt-BR'
      }).then((data: any) => {
        if (data?.[0]?.payer_costs) setInstallments(data[0].payer_costs);
      });
    }, 500);

    return () => clearTimeout(timer);
  }, [amount, isReady]);

  // Fun√ß√£o de Submit Manual
  const submit = async () => {
    if (!cardFormRef.current) throw new Error('Formul√°rio n√£o inicializado');

    // 1. For√ßar atualiza√ß√£o de campos ocultos (Documento)
    const docInput = document.getElementById('docNumberVisual') as HTMLInputElement;
    if (docInput) {
        const cleanDoc = docInput.value.replace(/\D/g, '');
        const hiddenDoc = document.getElementById('form-checkout__identificationNumber') as HTMLInputElement;
        const hiddenType = document.getElementById('form-checkout__identificationType') as HTMLSelectElement;
        
        if (hiddenDoc) {
            hiddenDoc.value = cleanDoc;
            hiddenDoc.dispatchEvent(new Event('input', { bubbles: true }));
        }
        if (hiddenType) {
            hiddenType.value = cleanDoc.length > 11 ? 'CNPJ' : 'CPF';
            hiddenType.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    // 2. Criar Token
    const tokenData = await cardFormRef.current.createCardToken({
      cardholderEmail: payerEmail,
    });

    if (!tokenData?.id && !tokenData?.token) {
        throw new Error('Dados do cart√£o inv√°lidos');
    }

    return {
        token: tokenData.id || tokenData.token,
        paymentMethodId: paymentMethodRef.current || (document.getElementById('paymentMethodId') as HTMLInputElement)?.value,
        installments: (document.getElementById('form-checkout__installments') as HTMLSelectElement)?.value,
        issuerId: (document.getElementById('form-checkout__issuer') as HTMLSelectElement)?.value
    };
  };

  return { isReady, installments, fieldErrors, clearFieldError, submit };
}
2. Substitua o arquivo src/components/payment/CustomCardForm.tsx
Agora o componente visual ser√° simples e limpo, usando o Hook acima.

TypeScript

import { useState, useRef, forwardRef, useImperativeHandle, memo } from 'react';
import { Lock } from "lucide-react";
import { toast } from "sonner";
import { useMercadoPagoBrick } from "@/hooks/useMercadoPagoBrick";

interface CustomCardFormProps {
  amount: number;
  payerEmail: string;
  mercadoPagoPublicKey: string;
  loading?: boolean;
  onSubmit: (tokenData: any, orderId?: string) => Promise<void>;
  cardFieldsStyle?: any;
}

export interface CustomCardFormRef {
  submit: (orderId?: string) => void;
}

const CustomCardFormComponent = forwardRef<CustomCardFormRef, CustomCardFormProps>(
  ({ amount, payerEmail, mercadoPagoPublicKey, loading = false, onSubmit, cardFieldsStyle }, ref) => {
    
    // Hook Personalizado (Frente 2)
    const { 
        isReady, 
        installments, 
        fieldErrors, 
        clearFieldError, 
        submit: submitToSDK 
    } = useMercadoPagoBrick({
        amount,
        publicKey: mercadoPagoPublicKey,
        payerEmail,
        onFormError: (msg) => toast.error(msg)
    });

    // Estado local para campos manuais (Nome, CPF)
    const [localErrors, setLocalErrors] = useState<any>({});

    // Expor fun√ß√£o de submit para o pai (PublicCheckout)
    useImperativeHandle(ref, () => ({
      submit: async (orderId?: string) => {
        setLocalErrors({}); // Limpa erros locais

        // 1. Valida√ß√£o Manual (Campos fora do iframe)
        const nameInput = document.getElementById('form-checkout__cardholderName') as HTMLInputElement;
        const docInput = document.getElementById('docNumberVisual') as HTMLInputElement;
        const installSelect = document.getElementById('form-checkout__installments') as HTMLSelectElement;
        
        const errors: any = {};
        if (!nameInput?.value?.trim()) errors.name = "Nome √© obrigat√≥rio";
        if (!docInput?.value?.trim()) errors.doc = "CPF/CNPJ obrigat√≥rio";
        if (!installSelect?.value) errors.installments = "Selecione as parcelas";

        if (Object.keys(errors).length > 0) {
            setLocalErrors(errors);
            toast.error("Verifique os campos obrigat√≥rios");
            throw new Error("Campos inv√°lidos");
        }

        try {
            // 2. Chama o Hook para processar com o SDK
            const data = await submitToSDK();
            
            // 3. Devolve para o pai (PublicCheckout)
            await onSubmit({
                token: data.token,
                installments: Number(data.installments),
                paymentMethodId: data.paymentMethodId,
                issuerId: data.issuerId
            }, orderId);

        } catch (error: any) {
            console.error("Erro no pagamento:", error);
            // Erros do SDK j√° atualizaram o estado 'fieldErrors' via Hook
            toast.error("Verifique os dados do cart√£o");
            throw error;
        }
      }
    }));

    // Styles
    const inputClass = `w-full h-10 px-3 rounded-lg border transition-all outline-none bg-white ${loading ? 'opacity-50' : ''}`;
    const errorClass = "ring-2 ring-red-500 border-red-500";

    return (
      <div className="w-full">
        <form id="form-checkout" className="space-y-4">
          
          {/* Cart√£o */}
          <div className="space-y-1">
            <label className="text-xs text-gray-500">N√∫mero do Cart√£o</label>
            <div 
                id="form-checkout__cardNumber" 
                className={`${inputClass} flex items-center ${fieldErrors.cardNumber ? errorClass : 'border-gray-300'}`}
                onClick={() => clearFieldError('cardNumber')}
            />
            {fieldErrors.cardNumber && <p className="text-red-500 text-xs">{fieldErrors.cardNumber}</p>}
          </div>

          <div className="grid grid-cols-2 gap-3">
            {/* Validade */}
            <div className="space-y-1">
                <label className="text-xs text-gray-500">Validade</label>
                <div 
                    id="form-checkout__expirationDate" 
                    className={`${inputClass} flex items-center ${fieldErrors.expirationDate ? errorClass : 'border-gray-300'}`}
                    onClick={() => clearFieldError('expirationDate')}
                />
                {fieldErrors.expirationDate && <p className="text-red-500 text-xs">{fieldErrors.expirationDate}</p>}
            </div>
            {/* CVV */}
            <div className="space-y-1">
                <label className="text-xs text-gray-500">CVV</label>
                <div 
                    id="form-checkout__securityCode" 
                    className={`${inputClass} flex items-center ${fieldErrors.securityCode ? errorClass : 'border-gray-300'}`}
                    onClick={() => clearFieldError('securityCode')}
                />
                {fieldErrors.securityCode && <p className="text-red-500 text-xs">{fieldErrors.securityCode}</p>}
            </div>
          </div>

          {/* Nome */}
          <div className="space-y-1">
            <label className="text-xs text-gray-500">Nome do Titular</label>
            <input 
                type="text" 
                id="form-checkout__cardholderName"
                placeholder="Como est√° no cart√£o"
                className={`${inputClass} ${localErrors.name ? errorClass : 'border-gray-300'}`}
                onChange={() => setLocalErrors((p: any) => ({...p, name: undefined}))}
            />
            {localErrors.name && <p className="text-red-500 text-xs">{localErrors.name}</p>}
          </div>

          {/* CPF/CNPJ (Visual + M√°scara) */}
          <div className="space-y-1">
            <label className="text-xs text-gray-500">CPF/CNPJ do Titular</label>
            <input 
                type="text" 
                id="docNumberVisual"
                placeholder="000.000.000-00"
                maxLength={18}
                className={`${inputClass} ${localErrors.doc ? errorClass : 'border-gray-300'}`}
                onChange={(e) => {
                    let v = e.target.value.replace(/\D/g, '');
                    if (v.length > 14) v = v.slice(0, 14);
                    if (v.length <= 11) v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                    else v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                    e.target.value = v;
                    setLocalErrors((p: any) => ({...p, doc: undefined}));
                }}
            />
            {localErrors.doc && <p className="text-red-500 text-xs">{localErrors.doc}</p>}
          </div>

          {/* Parcelas */}
          <div className="space-y-1">
            <label className="text-xs text-gray-500">Parcelamento</label>
            <select 
                id="form-checkout__installments"
                className={`${inputClass} ${localErrors.installments ? errorClass : 'border-gray-300'}`}
                onChange={() => setLocalErrors((p: any) => ({...p, installments: undefined}))}
            >
                {installments.length === 0 && <option disabled selected>Carregando...</option>}
                {installments.map((cost: any) => (
                    <option key={cost.installments} value={cost.installments}>
                        {cost.installments}x de {new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(cost.installment_amount)}
                    </option>
                ))}
            </select>
            {localErrors.installments && <p className="text-red-500 text-xs">{localErrors.installments}</p>}
          </div>

          {/* Campos Ocultos (SDK) */}
          <div className="hidden">
             <input type="email" id="form-checkout__cardholderEmail" value={payerEmail} readOnly />
             <select id="form-checkout__identificationType"><option value="CPF">CPF</option><option value="CNPJ">CNPJ</option></select>
             <input type="text" id="form-checkout__identificationNumber" />
             <input type="hidden" id="paymentMethodId" />
             <select id="form-checkout__issuer"></select>
          </div>

          <div className="flex items-center justify-center gap-2 pt-2 text-gray-500">
            <Lock className="w-4 h-4" />
            <p className="text-xs">Pagamento 100% seguro</p>
          </div>
        </form>

        {!isReady && (
            <div className="absolute inset-0 bg-white/80 flex items-center justify-center z-10">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>
        )}
      </div>
    );
  }
);

CustomCardFormComponent.displayName = 'CustomCardForm';
export const CustomCardForm = memo(CustomCardFormComponent);
‚úÖ Pr√≥ximos Passos (Checklist)
Crie o arquivo src/hooks/useMercadoPagoBrick.ts.

Substitua o conte√∫do de src/components/payment/CustomCardForm.tsx.

TESTE NOVAMENTE:

Verifique se o formul√°rio de cart√£o carrega.

Digite um cart√£o de teste (ex: 4111...)

Veja se as parcelas aparecem.

Tente fazer uma compra "fake" (se tiver credenciais de teste) ou apenas valide se o bot√£o "Pagar" dispara os erros de valida√ß√£o corretamente quando os campos est√£o vazios.

Assim que voc√™ validar isso, teremos completado a Frente 2 e seu c√≥digo estar√° anos-luz √† frente em qualidade! üöÄ