# =============================================================================
# CI/CD Pipeline - RiseCheckout
# 
# RISE ARCHITECT PROTOCOL V3 - 10.0/10
# 
# Enterprise-grade CI/CD pipeline with parallel jobs, caching, and quality gate.
# Blocks merges when tests fail or coverage is below thresholds.
# 
# Architecture:
#   install â†’ [unit-tests, e2e-tests, edge-functions] â†’ quality-gate
# 
# @module .github/workflows/ci
# =============================================================================

name: ðŸ§ª CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs when a new push is made
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "8"
  DENO_VERSION: "v1.x"

jobs:
  # ===========================================================================
  # Job 1: Install Dependencies with Cache
  # ===========================================================================
  install:
    name: ðŸ“¦ Install Dependencies
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ðŸ’¾ Cache node_modules
        id: cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: ðŸ“¥ Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile

  # ===========================================================================
  # Job 2: Unit & Integration Tests with Coverage
  # ===========================================================================
  unit-tests:
    name: ðŸ§ª Unit & Integration Tests
    needs: install
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ðŸ’¾ Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: ðŸ“¥ Install dependencies (if cache miss)
        run: pnpm install --frozen-lockfile

      - name: ðŸ§ª Run tests with coverage
        run: pnpm vitest run --coverage --reporter=json --outputFile=test-results.json
        env:
          CI: true

      - name: ðŸ“Š Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: ðŸ“‹ Generate coverage summary
        run: |
          echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            STATEMENTS=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct')
            BRANCHES=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct')
            LINES=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
            echo "| Metric | Coverage | Threshold |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|-----------|" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | ${STATEMENTS}% | 60% |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches | ${BRANCHES}% | 50% |" >> $GITHUB_STEP_SUMMARY
            echo "| Functions | ${FUNCTIONS}% | 60% |" >> $GITHUB_STEP_SUMMARY
            echo "| Lines | ${LINES}% | 60% |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Coverage report not found" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Job 3: E2E Tests with Playwright
  # ===========================================================================
  e2e-tests:
    name: ðŸŽ­ E2E Tests (Playwright)
    needs: install
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ðŸ’¾ Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - name: ðŸ“¥ Install dependencies (if cache miss)
        run: pnpm install --frozen-lockfile

      - name: ðŸ’¾ Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: ðŸŽ­ Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: ðŸŽ­ Run E2E tests
        run: pnpm exec playwright test --reporter=html
        env:
          CI: true
          BASE_URL: ${{ secrets.E2E_BASE_URL || 'http://localhost:5173' }}

      - name: ðŸ“Š Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: ðŸ“Š Upload test traces on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-traces
          path: test-results/
          retention-days: 7

      - name: ðŸ“‹ Generate E2E summary
        if: always()
        run: |
          echo "## ðŸŽ­ E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f playwright-report/index.html ]; then
            echo "âœ… Playwright report generated" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No Playwright report found" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================================================
  # Job 4: Edge Functions Tests with Deno
  # ===========================================================================
  edge-functions:
    name: âš¡ Edge Functions Tests
    needs: install
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¦• Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: ðŸ§ª Run Edge Function tests
        working-directory: ./supabase/functions
        run: |
          chmod +x ./run-tests.sh
          ./run-tests.sh
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'https://test.supabase.co' }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'test-key' }}
          MERCADOPAGO_WEBHOOK_SECRET: ${{ secrets.MERCADOPAGO_WEBHOOK_SECRET || 'test-secret' }}

      - name: ðŸ“‹ Generate Edge Functions summary
        if: always()
        run: |
          echo "## âš¡ Edge Functions Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests executed with Deno runtime" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 5: Quality Gate (Blocking)
  # ===========================================================================
  quality-gate:
    name: ðŸš¦ Quality Gate
    needs: [unit-tests, e2e-tests, edge-functions]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ðŸ” Check job results
        run: |
          echo "## ðŸš¦ Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Check unit-tests
          if [ "${{ needs.unit-tests.result }}" == "success" ]; then
            echo "| Unit Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Unit Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check e2e-tests
          if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "| E2E Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| E2E Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check edge-functions
          if [ "${{ needs.edge-functions.result }}" == "success" ]; then
            echo "| Edge Functions | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Edge Functions | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸš« Block if any check failed
        run: |
          if [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.e2e-tests.result }}" != "success" ] || \
             [ "${{ needs.edge-functions.result }}" != "success" ]; then
            echo ""
            echo "âŒ QUALITY GATE FAILED"
            echo ""
            echo "One or more required checks did not pass."
            echo "Please fix the failing tests before merging."
            echo ""
            exit 1
          fi
          
          echo ""
          echo "âœ… QUALITY GATE PASSED"
          echo ""
          echo "All required checks passed successfully!"
          echo "This PR is ready for merge."

      - name: ðŸŽ‰ Success notification
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Quality Gate: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed. This PR is ready for merge! ðŸš€" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Failure notification
        if: failure()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âŒ Quality Gate: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more checks failed. Please review and fix before merging." >> $GITHUB_STEP_SUMMARY
