# =============================================================================
# Security Scan Workflow - RiseCheckout
# =============================================================================
# This workflow runs on every push and PR to detect exposed secrets
# and other security vulnerabilities before they reach main.
# =============================================================================

name: ðŸ” Security Scan

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop, staging]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # ===========================================================================
  # Gitleaks - Secret Detection
  # ===========================================================================
  gitleaks:
    name: ðŸ” Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
          GITLEAKS_ENABLE_COMMENTS: true

  # ===========================================================================
  # TruffleHog - Deep Secret Scanning
  # ===========================================================================
  trufflehog:
    name: ðŸ· TruffleHog Deep Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # ===========================================================================
  # Dependency Security Audit
  # ===========================================================================
  dependency-audit:
    name: ðŸ“¦ Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

  # ===========================================================================
  # CodeQL Static Analysis
  # ===========================================================================
  codeql:
    name: ðŸ”¬ CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  # ===========================================================================
  # Security Report Summary
  # ===========================================================================
  security-summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, dependency-audit, codeql]
    if: always()
    steps:
      - name: Security Check Results
        run: |
          echo "## ðŸ” Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.gitleaks.result }}" == "success" ]; then
            echo "âœ… **Gitleaks**: No secrets detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Gitleaks**: Potential secrets found - REVIEW REQUIRED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.trufflehog.result }}" == "success" ]; then
            echo "âœ… **TruffleHog**: No verified secrets" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **TruffleHog**: Review recommended" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.dependency-audit.result }}" == "success" ]; then
            echo "âœ… **Dependencies**: No critical vulnerabilities" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Dependencies**: Audit warnings present" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.codeql.result }}" == "success" ]; then
            echo "âœ… **CodeQL**: No security issues detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **CodeQL**: Review recommended" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if secrets detected
        if: needs.gitleaks.result == 'failure'
        run: |
          echo "::error::ðŸš¨ SECRETS DETECTED! This PR cannot be merged until all secrets are removed."
          exit 1
